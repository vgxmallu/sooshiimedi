from pyrogram import filters
from pyrogram.types import InlineKeyboardButton, InlineKeyboardMarkup
import bs4, requests
from mbot import Mbot, LOG_GROUP






@Mbot.on_message(filters.regex(r'https?://.*instagram[^\s]+'), group=1)
async def link_handler(Mbot, message):
    link = message.matches[0].group(0)
    try:
        gm = await message.reply_text("🔎")
        url= link.replace("instagram.com","ddinstagram.com")
        await message.reply_video(url)
    except Exception as e:
        try:
            if "/reel/" in url:
               getdata = requests.get(url).text
               soup = bs4.BeautifulSoup(getdata, 'html.parser')
               meta_tag = soup.find('meta', attrs={'property': 'og:video'})
               content_value = meta_tag['content']
               Igbutton = InlineKeyboardMarkup(
                      [
                          [
                              InlineKeyboardButton('Open in Instagram', url=f'{link}')
                          ],[
                              InlineKeyboardButton('My Group', url='https://t.me/songdownload_group')
                          ]
                      ]
               )
               await message.reply_video(f"https://ddinstagram.com{content_value}", caption="**Downloaded via 𝗠ᴜsɪᴄ•𝕏•𝗗ʟ**\n\n**©️ @Musicx_dlbot**", reply_markup=Igbutton)
            elif "/p/" in url:
                 getdata = requests.get(url).text
                 soup = bs4.BeautifulSoup(getdata, 'html.parser')
                 meta_tag = soup.find('meta', attrs={'property': 'og:image'})
                 content_value = meta_tag['content']
                 await message.reply_photo(f"https://ddinstagram.com{content_value}", caption="**Downloaded via 𝗠ᴜsɪᴄ•𝕏•𝗗ʟ**\n\n**©️ @Musicx_dlbot**")
                 await gm.delete()
        except Exception as e:
            await message.reply_text(f"https://ddinstagram.com{content_value}")
            if LOG_GROUP:
               await Mbot.send_message(LOG_GROUP,f"Instagram {e} {content_value}")
            ##optinal 
            await message.reply(f"400: Sorry, Unable To Find It.\nif you don't get the result use this: **/igdl link**")
            
